<!DOCTYPE html>
<!--[if lt IE 7]> <html class="lt-ie10 lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="lt-ie10 lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="lt-ie10 lt-ie9"> <![endif]-->
<!--[if IE 9]> <html class="lt-ie10"> <![endif]-->
<!--[if gt IE 9]><!--> <html> <!--<![endif]-->
<head>
    <meta content="width=980" id="viewport" name="viewport">
    <title>BotanJS - vim</title>

    <meta name="description" content="Yet another vim implementation attempt with textarea">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

    <link rel="stylesheet" type="text/css" href="http://s.botanjs.astropenguin.net/ocss/Astro.Penguin.Github">
    <script src="http://s.botanjs.astropenguin.net/ojs/Astro.Penguin.Github"></script>

    <link rel="stylesheet" type="text/css" href="/BotanJS-vim/vima.css" />
    <script src="/BotanJS-vim/vima.js" ></script>

    <script>window.onload=function(){BotanJS.import("Astro.Bootstrap").init();}</script>
</head>
<body>

<div class="center">
    <div class="left">
        <h1> VimArea </h1>
        <p> VimArea is a vim implementation over a textarea. There's a plenty of online Vim out there with different degree of impl and approach. </p>
        <p> This one is none the other, the goal of this implementation is to minimize the footprint for creating additional iframe or divs. </p>
        <p> This is not a traditional vim ( yet ). I recommend to use wasavi if you can. It is a more mature project. Even if the project is finisished, it would not provide the functionality like wasavi does ( mostly because of the limitation of a textarea ). </p>
        <h2> Demo </h2>
        <div>
            <textarea id="vim-area" class="vima" rows="20" cols="80" spellcheck="false"></textarea>
        </div>
        <h3> Javascript: </h3>
        <div>
            <pre>
var d = BotanJS.import( "Dandelion" );
var vimArea = d.id( "vim-area", true );
vimArea.element.value = TestString;
var VimArea = new ( BotanJS.import( "Components.Vim.VimArea" ) )( vimArea );
            </pre>
        </div>
        <h3> Source Code </h3>
        <div>
        <ol>
            <li> This page: <a href="/BotanJS-vim/vima.js">js</a>, <a href="/BotanJS-vim/vima.css" >css</a> </li>
            <li> BotanJS API ( dev, VERY unstable. May contain syntax error ):
            <br />
            js ( <a href="http://s.botanjs.astropenguin.net/rjs/Components.Vim.VimArea" target="_blank">raw</a>,
            <a href="http://s.botanjs.astropenguin.net/ojs/Components.Vim.VimArea" target="_blank">compressed</a> )
            css ( <a href="http://s.botanjs.astropenguin.net/rcss/Components.Vim.VimArea" target="_blank">raw</a>,
            <a href="http://s.botanjs.astropenguin.net/ocss/Components.Vim.VimArea" target="_blank">compressed</a> )
            </li>
            <li> Project page: <a href="https://github.com/tgckpg/BotanJS-vim">Github</a> </li>
        </ol>
        </div>
    </div>
</div>

<script>
(function(){
 var TestString = "(function(){\n\tvar ns = __namespace( \"Components.Vim\" );\n\n\t/** @type {Dandelion.IDOMElement} */\n\tvar IDOMElement                             = __import( \"Dandelion.IDOMElement\" );\n\t/** @type {System.utils.DataKey} */\n\tvar DataKey                                 = __import( \"System.utils.DataKey\" );\n\t/** @type {System.Cycle} */\n\tvar Cycle                                   = __import( \"System.Cycle\" );\n\t/** @type {System.Debug} */\n\tvar debug                                   = __import( \"System.Debug\" );\n\n\t/** @type {Components.Vim.State.Registers} */\n\tvar Registers                                 = __import( \"Components.Vim.State.Registers\" );\n\t/** @type {Components.Vim.Syntax.Analyzer} */\n\tvar SyntaxAnalyzer                            = __import( \"Components.Vim.Syntax.Analyzer\" );\n\n\t/** @type {Components.Vim.LineFeeder} */\n\tvar LineFeeder = ns[ NS_INVOKE ]( \"LineFeeder\" );\n\t/** @type {Components.Vim.StatusBar} */\n\tvar StatusBar = ns[ NS_INVOKE ]( \"StatusBar\" );\n\n\tvar VimControls = ns[ NS_INVOKE ]( \"Controls\" );\n\tvar InputEvent = ns[ NS_INVOKE ]( \"InputEvent\" );\n\tvar mesg = ns[ NS_INVOKE ]( \"Message\" );\n\n\tvar Insts = [];\n\n\tvar KeyHandler = function( sender, handler )\n\t{\n\t\treturn function( e )\n\t\t{\n\t\t\te = e || window.event;\n\t\t\tif ( e.keyCode ) code = e.keyCode;\n\t\t\telse if ( e.which ) code = e.which;\n\n\t\t\thandler( sender, new InputEvent( sender, e ) );\n\t\t};\n\t};\n\n\t/* stage @param {Dandelion.IDOMElement} */\n\tvar VimArea = function( stage )\n\t{\n\t\tif( !stage ) return;\n\n\t\tvar element = stage.element;\n\n\t\tif( element.nodeName != \"TEXTAREA\" )\n\t\t{\n\t\t\tdebug.Error( \"Element is not compatible for VimArea\" );\n\t\t\treturn;\n\t\t}\n\n\t\tstage.setAttribute( new DataKey( \"vimarea\", 1 ) );\n\n\t\tthis.stage = stage;\n\t\tthis.rows = element.rows;\n\t\tthis.cols = element.cols;\n\n\t\tthis.__active = false;\n\n\t\tvar _self = this;\n\n\t\tstage.addEventListener( \"Focus\", function() { _self.__active = true; } );\n\t\tstage.addEventListener( \"Blur\", function() { _self.__active = false; } );\n\n\t\t// Init\n\t\tthis.VisualizeVimFrame( element.value );\n\n\t\t// Push this instance\n\t\tInsts.push( this );\n\t};\n\n\tVimArea.prototype.select = function( sel )\n\t{\n\t\tif( !this.__active ) return;\n\t\tvar textarea = this.stage.element;\n\n\t\tif( sel )\n\t\t{\n\t\t\ttextarea.selectionStart = sel.start;\n\t\t\ttextarea.selectionEnd = sel.end;\n\t\t}\n\t};\n\n\tVimArea.prototype.VisualizeVimFrame = function( content )\n\t{\n\t\tvar _self = this;\n\n\t\tvar element = this.stage.element;\n\t\tvar r = this.rows;\n\t\tvar c = this.cols;\n\n\t\t// StatusFeeder always consumes at least 1 line\n\t\tvar cRange = r - 1;\n\n\t\t// Content feeder\n\t\tvar cfeeder = new LineFeeder( cRange, c );\n        var contentAnalyzer = new SyntaxAnalyzer( cfeeder );\n\n\t\t// Feed the contents to content feeder\n\t\t// This \"\n\" fixes the last line \"\n\" not displaying\n\t\t// it will be trimmed after saving\n\t\tcfeeder.init( content + \"\n\" );\n\n\t\t// Status can consumes up to full screen, I think\n\t\tvar sfeeder = new LineFeeder( r, c );\n\t\tsfeeder.setRender( false );\n\n\t\t// Set the Vim instance\n\t\tcfeeder.cursor.Vim = this;\n\t\tsfeeder.cursor.Vim = this;\n\n\t\t// Set the stamps\n\t\tvar statusBar = new StatusBar( c );\n\t\tstatusBar.stamp( -18, function(){ return cfeeder.lineStat; } );\n\t\tstatusBar.stamp( -3, function(){ return mesg( cfeeder.docPos ); } );\n\t\tstatusBar.stamp( 0, function(){ return cfeeder.cursor.message; } );\n\n\t\tsfeeder.init( statusBar.statusText );\n\n\t\tvar Update = function()\n\t\t{\n\t\t\tsfeeder.init( statusBar.statusText );\n\n\t\t\telement.value =\n\t\t\t\tcfeeder.render( 0, r - sfeeder.linesOccupied )\n\t\t\t\t+ \"\n\" + sfeeder.render();\n\n\t\t\t_self.__blink = false;\n\t\t\t_self.select( cfeeder.cursor.position );\n\t\t};\n\n\t\tcfeeder.dispatcher.addEventListener( \"VisualUpdate\", Update );\n\t\tUpdate();\n\n\t\tthis.contentFeeder = cfeeder;\n        this.contentAnalyzer = contentAnalyzer;\n\t\tthis.statusFeeder = sfeeder;\n\t\tthis.statusBar = statusBar;\n\t\tthis.registers = new Registers();\n\n\t\tthis.__cursor = cfeeder.cursor;\n\n\t\tthis.__blink = true;\n\t\tCycle.perma( \"VimCursorBlinkCycle\" + element.id, function()\n\t\t{\n\t\t\t_self.select(\n\t\t\t\t!_self.__cursor.blink || ( _self.__blink = !_self.__blink )\n\t\t\t\t\t? _self.__cursor.position\n\t\t\t\t\t: { start: 0, end: 0 }\n\t\t\t);\n\t\t}, 600 );\n\n\t\tvar controls = new VimControls( this );\n\t\tthis.stage.addEventListener(\n\t\t\t\"KeyDown\"\n\t\t\t, KeyHandler( this, controls.handler.bind( controls ) )\n\t\t);\n\t};\n\n\t__readOnly( VimArea, \"Instances\", function() {\n\t\treturn Insts.slice();\n\t} );\n\n\t__readOnly( VimArea.prototype, \"content\", function() {\n\t\treturn this.contentFeeder.content.slice( 0, -1 );\n\t} );\n\n\tns[ NS_EXPORT ]( EX_CLASS, \"VimArea\", VimArea );\n})();";

    var d = BotanJS.import( "Dandelion" );
    var vimArea = d.id( "vim-area", true );
    vimArea.element.value = TestString;

    var VimArea = new ( BotanJS.import( "Components.Vim.VimArea" ) )( vimArea );
})();
</script>
</body>
</html>
